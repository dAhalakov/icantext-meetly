<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Meeting Planner</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>

        <div class="app">

            <h1>Meeting Planner</h1>

            <div class="create-event">
                <input type="text" id="eventTitle" placeholder="Event title">

                <select id="durationSelect">
                    <option value="15">15 min</option>
                    <option value="30">30 min</option>
                    <option value="45">45 min</option>
                    <option value="60">1 hour</option>
                    <option value="120">2 hours</option>
                    <option value="180">3 hours</option>
                    <option value="240">4 hours</option>
                    <option value="allday">All day</option>
                </select>

                <input type="datetime-local" id="dateInputStart">

                <button id="addDateBtn">Add date</button>
                <button id="createEventBtn">Create event</button>
            </div>

            <div id="datesList"></div>

            <div id="pollSection" class="hidden">
                <h2 id="pollTitle"></h2>
                <table id="pollTable"></table>
            </div>

        </div>

        <script src="https://icantext.com/ICTBridgeSDK.js"></script>
        <script>

            // =====================
            // SDK INITIALIZATION
            // =====================

            const sdk = new ICTBridgeSDK("icantext_meetly_app");
            let connection;
            let localUser = null;

            async function initApp() {
                connection = await sdk.init();

                if (connection.status === "READY") {
                    localUser = connection.localPseudonym;
                    console.log("Connected as:", localUser);
                }
            }

            initApp();

            // =====================
            // DOM REFERENCES
            // =====================

            const addDateBtn = document.getElementById("addDateBtn");
            const createEventBtn = document.getElementById("createEventBtn");
            const dateInputStart = document.getElementById("dateInputStart");
            const durationSelect = document.getElementById("durationSelect");
            const datesList = document.getElementById("datesList");
            const pollSection = document.getElementById("pollSection");
            const pollTable = document.getElementById("pollTable");
            const pollTitle = document.getElementById("pollTitle");

            // =====================
            // STATE
            // =====================

            let dates = [];
            let votes = {};
            let eventDuration = null;
            let currentEvent = null;

            // =====================
            // DATE FORMATTING
            // =====================

            const optionsDate = {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric"
            };

            const optionsDateTime = {
                ...optionsDate,
                hour: "2-digit",
                minute: "2-digit"
            };

            // =====================
            // ADD DATE
            // =====================

            addDateBtn.addEventListener("click", () => {
                const startValue = dateInputStart.value;
                if (!startValue) return;

                if (!eventDuration) {
                    eventDuration = durationSelect.value;
                    durationSelect.disabled = true;
                }

                const startDate = new Date(startValue);
                dates.push(startDate);

                renderDatesList();
                dateInputStart.value = "";
            });

            function renderDatesList() {
                datesList.innerHTML = "";

                dates.forEach((date, index) => {
                    const div = document.createElement("div");
                    div.className = "date-item";

                    let text;

                    if (eventDuration === "allday") {
                        text = date.toLocaleDateString(undefined, optionsDate) + " (All day)";
                    } else {
                        text = date.toLocaleString(undefined, optionsDateTime) +
                               " (" + eventDuration + " min)";
                    }

                    div.innerHTML = text +
                        `<button onclick="removeDate(${index})" style="margin-left:10px;background:#e74c3c;">X</button>`;

                    datesList.appendChild(div);
                });
            }

            function removeDate(index) {
                dates.splice(index, 1);

                if (dates.length === 0) {
                    durationSelect.disabled = false;
                    eventDuration = null;
                }

                renderDatesList();
            }

            // =====================
            // CREATE EVENT
            // =====================

            createEventBtn.addEventListener("click", () => {
                console.log("Button clicked");
                console.log("SDK status:", sdk.status);
                const title = document.getElementById("eventTitle").value;
                if (!title || dates.length === 0) return;

                const eventData = {
                    id: Date.now().toString(),
                    title,
                    dates,
                    duration: eventDuration,
                    votes: {}
                };

                currentEvent = eventData;

                sdk.sendData(JSON.stringify({
                    type: "EVENT_CREATED",
                    payload: eventData
                }));
            });

            // =====================
            // RECEIVE DATA
            // =====================

            sdk.onData((from, payload) => {
                const message = JSON.parse(payload);

                if (message.type === "EVENT_CREATED") {
                    currentEvent = message.payload;
                    dates = currentEvent.dates.map(d => new Date(d));
                    eventDuration = currentEvent.duration;
                    votes = currentEvent.votes || {};

                    pollTitle.textContent = currentEvent.title;
                    pollSection.classList.remove("hidden");

                    renderTable();
                }

                if (message.type === "VOTE_UPDATE") {
                    if (currentEvent && message.payload.eventId === currentEvent.id) {
                        votes = message.payload.votes;
                        renderTable();
                    }
                }
            });

            // =====================
            // RENDER TABLE
            // =====================

            function renderTable() {
                pollTable.innerHTML = "";

                const headerRow = document.createElement("tr");
                headerRow.innerHTML = "<th>Participant</th>";

                dates.forEach(date => {
                    let formatted;

                    if (eventDuration === "allday") {
                        formatted = date.toLocaleDateString(undefined, optionsDate) +
                                    "<br><small>All day</small>";
                    } else {
                        formatted = date.toLocaleString(undefined, optionsDateTime) +
                                    "<br><small>" + eventDuration + " min</small>";
                    }

                    headerRow.innerHTML += `<th>${formatted}</th>`;
                });

                pollTable.appendChild(headerRow);

                const inputRow = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = localUser;
                inputRow.appendChild(nameCell);

                const hasVoted = votes[localUser];

                dates.forEach((_, index) => {
                    const td = document.createElement("td");
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";

                    if (hasVoted) {
                        checkbox.checked = votes[localUser].includes(index);
                        checkbox.disabled = true;
                    }

                    td.appendChild(checkbox);
                    inputRow.appendChild(td);
                });

                const voteCell = document.createElement("td");

                if (!hasVoted) {
                    const voteBtn = document.createElement("button");
                    voteBtn.textContent = "Vote";

                    voteBtn.addEventListener("click", () => {

                        votes[localUser] = [];

                        const checkboxes = inputRow.querySelectorAll("input[type='checkbox']");
                        checkboxes.forEach((cb, index) => {
                            if (cb.checked) {
                                votes[localUser].push(index);
                            }
                        });

                        sdk.sendData(JSON.stringify({
                            type: "VOTE_UPDATE",
                            payload: {
                                eventId: currentEvent.id,
                                votes
                            }
                        }));
                    });

                    voteCell.appendChild(voteBtn);
                } else {
                    const removeBtn = document.createElement("button");
                    removeBtn.textContent = "Remove vote";

                    removeBtn.addEventListener("click", () => {
                        delete votes[localUser];

                        sdk.sendData(JSON.stringify({
                            type: "VOTE_UPDATE",
                            payload: {
                                eventId: currentEvent.id,
                                votes
                            }
                        }));
                    });

                    voteCell.appendChild(removeBtn);
                }

                inputRow.appendChild(voteCell);
                pollTable.appendChild(inputRow);

                renderResults();
            }

            // =====================
            // RENDER RESULTS
            // =====================

            function renderResults() {
                const resultsRow = document.createElement("tr");
                resultsRow.innerHTML = "<td><b>Votes</b></td>";

                dates.forEach((_, index) => {
                    let count = 0;

                    for (let user in votes) {
                        if (votes[user].includes(index)) count++;
                    }

                    resultsRow.innerHTML += `<td><b>${count}</b></td>`;
                });

                pollTable.appendChild(resultsRow);
            }
        </script>
    </body>
</html>
